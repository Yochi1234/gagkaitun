--[[
    @author Grow a Garden - Auto to 300 Tomatoes (v3)
    @description Auto-farm from scratch until you have 300 Tomato crops grown (faster + stable)
]]

task.wait(3)

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer

if not LocalPlayer then return end
if not LocalPlayer.Character then LocalPlayer.CharacterAdded:Wait() end

-- Wait for leaderstats
local function WaitForLeaderstats()
    local stats = LocalPlayer:FindFirstChild("leaderstats")
    local tries = 0
    while not stats and tries < 30 do
        stats = LocalPlayer:FindFirstChild("leaderstats")
        tries += 1
        task.wait(1)
    end
    return stats
end

local Leaderstats = WaitForLeaderstats()
if not Leaderstats then
    print("❌ No leaderstats found, aborting.")
    return
end

local Sheckles = Leaderstats:FindFirstChild("Sheckles") or Leaderstats:FindFirstChild("Money")
if not Sheckles then
    print("❌ No money stat found, aborting.")
    return
end

local GameEvents = nil
for _, name in {"GameEvents", "Events", "Remotes", "RE", "ServerEvents"} do
    local folder = ReplicatedStorage:FindFirstChild(name)
    if folder then
        GameEvents = folder
        break
    end
end
if not GameEvents then
    print("❌ No GameEvents folder found, aborting.")
    return
end

print("📦 GameEvents folder: " .. GameEvents.Name)

local function GetMyFarm()
    for _, farm in Workspace:GetChildren() do
        if farm:FindFirstChild("Important") then
            local data = farm.Important:FindFirstChild("Data")
            if data and data:FindFirstChild("Owner") and data.Owner.Value == LocalPlayer.Name then
                return farm
            end
        end
    end
    return nil
end

local function WaitForMyFarm(timeoutSeconds)
    timeoutSeconds = timeoutSeconds or 20
    local farm = GetMyFarm()
    local waited = 0
    while not farm and waited < timeoutSeconds do
        task.wait(1)
        waited = waited + 1
        farm = GetMyFarm()
        print("⏳ Waiting for farm... " .. waited .. "s")
    end
    if not farm then
        warn("⚠️ No farm found after waiting " .. timeoutSeconds .. " seconds.")
    else
        print("✅ Farm found: " .. farm.Name)
    end
    return farm
end

local function TryBuySeed(seedName)
    for _, evt in {"BuySeed", "BuySeedStock", "BuySeeds", "PurchaseSeed"} do
        local event = GameEvents:FindFirstChild(evt)
        if event then
            local success = pcall(function()
                print("🛒 Buying seed: " .. seedName .. " via " .. evt)
                event:FireServer(seedName)
            end)
            if success then
                return true
            end
        end
    end
    return false
end

local function PlantSeed(seedName)
    local farm = GetMyFarm()
    if not farm then
        print("⚠️ No farm found to plant")
        return
    end
    local pos = farm:GetPivot().Position + Vector3.new(0, 0.13, 0)
    for _, evt in {"PlantSeed", "Plant", "Plant_RE"} do
        local event = GameEvents:FindFirstChild(evt)
        if event then
            print("🌱 Planting " .. seedName .. " via " .. evt)
            event:FireServer(Vector3.new(pos.X, pos.Y, pos.Z), seedName)
            break
        end
    end
end

local function Harvest()
    local farm = GetMyFarm()
    if not farm then
        print("⚠️ No farm found to harvest")
        return
    end
    local plants = farm.Important:FindFirstChild("Plants_Physical")
    if not plants then return end
    local count = 0
    for _, crop in pairs(plants:GetChildren()) do
        local prompt = crop:FindFirstChildWhichIsA("ProximityPrompt", true)
        if prompt and prompt.Enabled then
            fireproximityprompt(prompt)
            task.wait(0.05)
            count += 1
        end
    end
    print("🌾 Harvested " .. count .. " crops")
end

local function Sell()
    local sellPos = CFrame.new(62, 4, -26)
    local char = LocalPlayer.Character
    if char and char:FindFirstChild("HumanoidRootPart") then
        char.HumanoidRootPart.CFrame = sellPos
        task.wait(0.5)
    end
    for _, evt in {"SellInventory", "SellAll", "Sell", "Sell_Inventory"} do
        local event = GameEvents:FindFirstChild(evt)
        if event then
            print("💰 Selling crops via " .. evt)
            event:FireServer()
            break
        end
    end
end

local function CountTomato()
    local farm = GetMyFarm()
    if not farm then return 0 end
    local count = 0
    local plants = farm.Important:FindFirstChild("Plants_Physical")
    if plants then
        for _, crop in pairs(plants:GetChildren()) do
            if crop.Name == "Tomato" then
                count += 1
            end
        end
    end
    return count
end

local function FarmToTomato300_Fast()
    print("🚀 Starting Fast Auto-Farm to 300 Tomatoes...")
    local farm = WaitForMyFarm(20)
    if not farm then
        print("❌ Farm not found, aborting.")
        return
    end
    
    while true do
        local tomatoes = CountTomato()
        print("🍅 Tomato Count: " .. tomatoes)
        if tomatoes >= 300 then
            print("✅ Reached 300 Tomato plants!")
            break
        end

        local seedToUse = "Tomato"
        if Sheckles.Value < 30 or not TryBuySeed("Tomato") then
            print("🔄 Tomato unavailable or low money, using Carrot...")
            seedToUse = "Carrot"
            TryBuySeed("Carrot")
        end

        PlantSeed(seedToUse)
        task.wait(0.5)

        Harvest()
        task.wait(0.5)

        Sell()
        task.wait(1)
    end
end

FarmToTomato300_Fast()
