--[[
    @author Grow a Garden - Auto to 300 Tomatoes (v3.1)
    @description Auto-farm from scratch until you have 300 Tomato crops grown (improved farm detection)
]]

-- Wait for game to load completely before doing anything
task.wait(3)

-- Initialize services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer

if not LocalPlayer then return end
if not LocalPlayer.Character then LocalPlayer.CharacterAdded:Wait() end

-- Wait for leaderstats
local function WaitForLeaderstats()
    local stats = LocalPlayer:FindFirstChild("leaderstats")
    local tries = 0
    while not stats and tries < 30 do
        stats = LocalPlayer:FindFirstChild("leaderstats")
        tries += 1
        task.wait(1)
    end
    return stats
end

local Leaderstats = WaitForLeaderstats()
if not Leaderstats then print("❌ No leaderstats") return end

-- Find Sheckles
local Sheckles = Leaderstats:FindFirstChild("Sheckles") or Leaderstats:FindFirstChild("Money")
if not Sheckles then print("❌ No money stat") return end

-- GameEvents detection
local GameEvents = nil
for _, name in {"GameEvents", "Events", "Remotes", "RE", "ServerEvents"} do
    local folder = ReplicatedStorage:FindFirstChild(name)
    if folder then GameEvents = folder break end
end
if not GameEvents then print("❌ No GameEvents folder found") return end

print("📦 GameEvents folder: " .. GameEvents.Name)

-- Improved Get My Farm with flexible name matching
local function GetMyFarm()
    for _, child in pairs(Workspace:GetDescendants()) do
        if child:IsA("Model") and child:FindFirstChild("Important") then
            local data = child.Important:FindFirstChild("Data")
            if data and data:FindFirstChild("Owner") and data.Owner.Value == LocalPlayer.Name then
                print("✅ Found player farm: " .. child.Name)
                return child
            end
        end
    end
    print("❌ No matching farm found")
    return nil
end

local function WaitForMyFarm(timeout)
    timeout = timeout or 20
    local elapsed = 0
    while elapsed < timeout do
        local farm = GetMyFarm()
        if farm then return farm end
        task.wait(1)
        elapsed += 1
        print("⏳ Waiting for farm... (" .. elapsed .. "s)")
    end
    return nil
end

-- Try buy seed and return success
local function TryBuySeed(seedName)
    for _, evt in {"BuySeed", "BuySeedStock", "BuySeeds", "PurchaseSeed"} do
        local event = GameEvents:FindFirstChild(evt)
        if event then
            local success = pcall(function()
                print("🛒 Buying seed: " .. seedName .. " via " .. evt)
                event:FireServer(seedName)
            end)
            if success then return true end
        end
    end
    return false
end

-- Farming Functions
local function PlantSeed(seedName)
    local farm = WaitForMyFarm()
    if not farm then print("⚠️ No farm found") return end
    local pos = farm:GetPivot().Position + Vector3.new(0, 0.13, 0)
    for _, evt in {"PlantSeed", "Plant", "Plant_RE"} do
        local event = GameEvents:FindFirstChild(evt)
        if event then
            print("🌱 Planting " .. seedName .. " via " .. evt)
            event:FireServer(Vector3.new(pos.X, pos.Y, pos.Z), seedName)
            break
        end
    end
end

local function Harvest()
    local farm = WaitForMyFarm()
    if not farm then return end
    local plants = farm.Important:FindFirstChild("Plants_Physical")
    if not plants then return end
    local count = 0
    for _, crop in pairs(plants:GetChildren()) do
        local prompt = crop:FindFirstChildWhichIsA("ProximityPrompt", true)
        if prompt and prompt.Enabled then
            fireproximityprompt(prompt)
            task.wait(0.05)
            count += 1
        end
    end
    print("🌾 Harvested " .. count .. " crops")
end

local function Sell()
    local sellPos = CFrame.new(62, 4, -26)
    local char = LocalPlayer.Character
    if char and char:FindFirstChild("HumanoidRootPart") then
        char.HumanoidRootPart.CFrame = sellPos
        task.wait(0.3)
    end
    for _, evt in {"SellInventory", "SellAll", "Sell", "Sell_Inventory"} do
        local event = GameEvents:FindFirstChild(evt)
        if event then
            print("💰 Selling crops via " .. evt)
            event:FireServer()
            break
        end
    end
end

-- Count tomato plants
local function CountTomato()
    local farm = WaitForMyFarm()
    if not farm then return 0 end
    local count = 0
    local plants = farm.Important:FindFirstChild("Plants_Physical")
    if plants then
        for _, crop in pairs(plants:GetChildren()) do
            if crop.Name == "Tomato" then
                count += 1
            end
        end
    end
    return count
end

-- Main Loop
local function FarmToTomato300()
    print("🚀 Starting Auto-Farm to 300 Tomatoes...")
    while true do
        local tomatoes = CountTomato()
        print("🍅 Tomato Count: " .. tomatoes)
        if tomatoes >= 300 then
            print("✅ Reached 300 Tomato plants!")
            break
        end

        local seedToUse = "Tomato"
        if Sheckles.Value < 30 or not TryBuySeed("Tomato") then
            print("🔄 Tomato unavailable or low money, using Carrot...")
            seedToUse = "Carrot"
            TryBuySeed("Carrot")
        end

        task.wait(0.1)
        PlantSeed(seedToUse)
        task.wait(0.1)
        Harvest()
        task.wait(0.1)
        Sell()
        task.wait(0.2)
    end
end

-- Start
FarmToTomato300()

-- GUI Notice
local gui = Instance.new("ScreenGui", game.CoreGui)
gui.Name = "AutoFarmNotice"
local label = Instance.new("TextLabel", gui)
label.Size = UDim2.new(0.3, 0, 0.05, 0)
label.Position = UDim2.new(0.35, 0, 0.05, 0)
label.Text = "🌿 Tomato AutoFarm: Running..."
label.TextScaled = true
label.BackgroundColor3 = Color3.fromRGB(0, 150, 0)
label.TextColor3 = Color3.new(1,1,1)
